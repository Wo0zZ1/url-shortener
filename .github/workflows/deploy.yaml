name: CI/CD Pipeline

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  KUBE_NAMESPACE: url-shortener

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # --- 1. Checkout —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è ---
      - name: Checkout repository with submodules
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set lowercase owner
        run: echo "IMAGE_PREFIX=${GITHUB_REPOSITORY_OWNER,,}" >> $GITHUB_ENV

      # --- 2. –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –≤ GitHub Container Registry ---
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # --- 3. –°–±–æ—Ä–∫–∞ –∏ –ø—É—à –æ–±—Ä–∞–∑–æ–≤ –¥–ª—è –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ ---
      - name: Build & Push Docker images
        run: |
          services=("api-gateway" "service-a" "service-b" "service-c")
          for service in "${services[@]}"; do
            echo "üîß Building $service..."
            docker build -t $REGISTRY/${IMAGE_PREFIX}/${service}:latest ./${service}
            docker push $REGISTRY/${IMAGE_PREFIX}/${service}:latest
          done

      # --- 4. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ kubectl ---
      - name: Set up kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: "latest"

      # --- 5. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–ª–∞—Å—Ç–µ—Ä—É ---
      # –°–µ–∫—Ä–µ—Ç KUBE_CONFIG_DATA –Ω—É–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –≤—Ä—É—á–Ω—É—é –≤ GitHub Secrets
      - name: Configure kubectl
        run: |
          echo "${{ secrets.KUBE_CONFIG_DATA }}" | base64 --decode > $HOME/.kube/config

      # --- 6. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∞–Ω–∏—Ñ–µ—Å—Ç–æ–≤ ---
      - name: Apply Kubernetes manifests
        run: |
          kubectl apply -f k8s/namespace.yaml
          kubectl apply -R -f k8s/

      # --- 7. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ ---
      - name: Check deployment status
        run: |
          kubectl get pods -n $KUBE_NAMESPACE
          kubectl get svc -n $KUBE_NAMESPACE
          kubectl get ingress -n $KUBE_NAMESPACE
