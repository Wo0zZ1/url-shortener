name: CI/CD Pipeline

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  KUBE_NAMESPACE: url-shortener

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # --- 1. Checkout —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è ---
      - name: Checkout repository with submodules
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # --- 2. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º owner –≤ –Ω–∏–∂–Ω–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–µ ---
      - name: Set lowercase owner
        run: echo "IMAGE_PREFIX=${GITHUB_REPOSITORY_OWNER,,}" >> $GITHUB_ENV

      # --- 3. –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –≤ GitHub Container Registry ---
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # --- 4. –°–±–æ—Ä–∫–∞ –∏ –ø—É—à –æ–±—Ä–∞–∑–æ–≤ –¥–ª—è –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ ---
      - name: Build & Push Docker images
        run: |
          services=("api-gateway" "user-service" "auth-service" "link-service")
          for service in "${services[@]}"; do
            echo "üîß Building $service..."
            docker build -t $REGISTRY/${IMAGE_PREFIX}/${service}:latest ./${service}
            docker push $REGISTRY/${IMAGE_PREFIX}/${service}:latest
          done

      # --- 5. –ü–æ–¥–Ω–∏–º–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π Kubernetes-–∫–ª–∞—Å—Ç–µ—Ä ---
      - name: Create Kubernetes cluster
        uses: helm/kind-action@v1
        with:
          cluster_name: url-shortener-ci
          wait: 60s

      # --- 6. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ kubectl ---
      - name: Set up kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: "latest"

      # --- 7. –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ ---
      - name: Verify cluster
        run: kubectl cluster-info

      # --- 8. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∞–Ω–∏—Ñ–µ—Å—Ç–æ–≤ ---
      - name: Apply Kubernetes manifests
        run: |
          kubectl apply -f k8s/namespace.yaml
          kubectl apply -R -f k8s/

      # --- 9. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ ---
      - name: Check deployment status
        run: |
          kubectl get pods -n $KUBE_NAMESPACE
          kubectl get svc -n $KUBE_NAMESPACE
          kubectl get ingress -n $KUBE_NAMESPACE
